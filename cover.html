<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lab Report Index Page (A4 + Editable + PDF)</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>

  <!-- jsPDF + html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    /* A4 exact page */
    .a4-page{
      width:210mm; height:297mm;
      background:#fff; color:#111;
      position: relative;
      overflow: hidden;
    }

    @media print{
      #topbar, #outerCard, #hint { display:none !important; }
      .a4-page{ box-shadow:none !important; border-radius:0 !important; }
      body{ background:#fff !important; }
    }

    /* Editable */
    .editable{
      outline:none;
      border-radius:6px;
      padding:2px 6px;
    }
    .editable:focus{
      background: rgba(77,163,255,.10);
      box-shadow: 0 0 0 2px rgba(77,163,255,.35);
    }
    body.exporting .editable:focus{
      background: transparent !important;
      box-shadow: none !important;
    }

    /* Table base */
    table{ width:100%; border-collapse:collapse; table-layout:fixed; }
    th, td{
      border:1px solid #111;
      padding:0;
      vertical-align: middle;
    }
    th{
      background:#f3f4f6;
      text-align:center;
      font-weight:900;
      font-size:13px;
      padding:10px 8px;
    }

    /* FIX: Outer cell controls vertical centering (stable in PDF capture) */
    .cell{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;       /* vertical center */
      justify-content:center;   /* default center */
      padding:0;                /* padding goes inside */
      box-sizing:border-box;
    }
    .cell-left{ justify-content:flex-start; text-align:left; }
    .cell-center{ justify-content:center; text-align:center; }

    /* FIX: Inner text/editable box */
    .cellText{
      width:100%;
      padding:8px 10px;
      box-sizing:border-box;
      font-size:13px;
      line-height:1.25;
    }

    /* Title wrap => multi-line */
    .cell-wrap{
      white-space: normal;
      word-break: break-word;
      overflow: visible;
    }

    /* Date/Remarks one-line */
    .cell-nowrap{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Zebra rows */
    #tbody tr:nth-child(odd) td{ background:#ffffff; }
    #tbody tr:nth-child(even) td{ background:#eaf4ff; }
    #tbody td .cell{ background: transparent; }

    /* Export lock */
    body.exporting #page,
    body.exporting .a4-page{
      transform:none !important;
      filter:none !important;
    }

    /* Info line aligned "Label : Value" */
    .info-row{
      display:grid;
      grid-template-columns: 34mm 4mm 1fr;
      gap: 0;
      align-items: baseline;
      margin-bottom: 4px;
      white-space: nowrap;
    }
    .info-label{ font-weight: 900; white-space: nowrap; }
    .info-colon{ font-weight: 900; text-align:center; white-space: nowrap; }
    .info-value{
      min-width: 90mm;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Fixed table area: adding rows makes all rows smaller to fit */
    .table-area{
      height: 144mm; /* 12 rows fit originally; now rows shrink/grow inside this */
      position: relative;
    }
    .table-area table{ height:100%; }
  </style>
</head>

<body class="m-0 font-sans text-white bg-[radial-gradient(1200px_600px_at_10%_10%,#1c2a4a_0%,#0b1220_55%,#060a14_100%)]">

  <!-- Top bar -->
  <div id="topbar" class="sticky top-0 z-50 border-b border-white/10 bg-slate-950/70 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex flex-wrap items-center justify-between gap-2">
      <div class="text-sm text-white/90">
        <span class="font-semibold">Lab Report</span>
        <span class="text-white/60">• Index Page • A4 • Editable • PDF</span>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="addRowBtn"
          class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/15 border border-white/10 text-sm">
          + Add Row
        </button>
        <button id="removeRowBtn"
          class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/15 border border-white/10 text-sm">
          − Remove Last
        </button>
        <button id="pdfBtn"
          class="px-3 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold">
          Download PDF
        </button>
        <a href="index.html" class="rounded-xl border border-white/10 px-3 py-2 text-sm hover:bg-white/5">← Home</a>
      </div>
    </div>
  </div>

  <div id="hint" class="max-w-6xl mx-auto px-4 pt-4 text-sm text-white/70">
    টেবিলের ভিতরে ক্লিক করে লিখতে পারবেন। PDF করলে website এ যেমন দেখায় ঠিক তেমনই থাকবে।
  </div>

  <!-- Preview card -->
  <div id="outerCard" class="max-w-6xl mx-auto px-4 pb-10">
    <div class="mt-4 rounded-2xl border border-white/10 bg-slate-900/60 backdrop-blur p-4">
      <div class="flex justify-center overflow-auto">
        <div id="page" class="a4-page rounded-xl shadow-[0_22px_80px_rgba(0,0,0,.55)]">

          <!-- A4 padding -->
          <div class="h-full p-[14mm] flex flex-col">

            <!-- Header -->
            <div>
              <div class="flex justify-center">
                <img
                  id="logoPreview"
                  src="Image/Logo_of_Premier_University_(PU).png"
                  alt="Premier University Logo"
                  class="h-[36mm] w-[54mm] object-contain"
                />
              </div>

              <div class="mt-2 text-center text-blue-400">
                <div id="p_uniTitle" class="editable inline-block text-[18pt] font-black tracking-wide" contenteditable="true">
                  PREMIER UNIVERSITY CHATTOGRAM
                </div>
              </div>
            </div>

            <!-- Content -->
            <div class="mt-4 text-black text-[11.5pt] leading-[1.55]">

              <!-- Info -->
              <div class="info-row">
                <div class="info-label">Name</div>
                <div class="info-colon">:</div>
                <div class="editable info-value" contenteditable="true">______________________________</div>
              </div>

              <div class="info-row">
                <div class="info-label">ID</div>
                <div class="info-colon">:</div>
                <div class="editable info-value" contenteditable="true">______________________________</div>
              </div>

              <div class="info-row">
                <div class="info-label">Course Title</div>
                <div class="info-colon">:</div>
                <div class="editable info-value" contenteditable="true">Neural Network &amp; Fuzzy Logic Laboratory</div>
              </div>

              <div class="info-row" style="margin-bottom: 10px;">
                <div class="info-label">Course Code</div>
                <div class="info-colon">:</div>
                <div class="editable info-value" contenteditable="true">CSE 452</div>
              </div>

              <!-- Index title -->
              <div class="mt-2 text-center text-blue-400">
                <div class="text-[20pt] font-extrabold">Index</div>
              </div>

              <!-- Table -->
              <div class="mt-3 table-area" id="tableArea">
                <table class="text-black">
                  <thead>
                    <tr>
                      <th class="text-blue-400" style="width:12%;">No</th>
                      <th class="text-blue-400" style="width:56%;">Title</th>
                      <th class="text-blue-400" style="width:18%;">Date</th>
                      <th class="text-blue-400" style="width:14%;">Remarks</th>
                    </tr>
                  </thead>

                  <tbody id="tbody">
                    <!-- 12 default rows -->
                    <!-- Row template used below -->
                    <tr>
                      <td>
                        <div class="cell cell-center"><div class="cellText font-semibold">1</div></div>
                      </td>
                      <td>
                        <div class="cell cell-left"><div class="cellText editable cell-wrap" contenteditable="true"></div></div>
                      </td>
                      <td>
                        <div class="cell cell-center"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div>
                      </td>
                      <td>
                        <div class="cell cell-left"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div>
                      </td>
                    </tr>

                    <tr>
                      <td><div class="cell cell-center"><div class="cellText font-semibold">2</div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-wrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-center"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                    </tr>

                    <tr>
                      <td><div class="cell cell-center"><div class="cellText font-semibold">3</div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-wrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-center"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                    </tr>

                    <tr>
                      <td><div class="cell cell-center"><div class="cellText font-semibold">4</div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-wrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-center"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                    </tr>

                    <tr>
                      <td><div class="cell cell-center"><div class="cellText font-semibold">5</div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-wrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-center"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                    </tr>

                    <tr>
                      <td><div class="cell cell-center"><div class="cellText font-semibold">6</div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-wrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-center"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                    </tr>

                    <tr>
                      <td><div class="cell cell-center"><div class="cellText font-semibold">7</div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-wrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-center"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                    </tr>

                    <tr>
                      <td><div class="cell cell-center"><div class="cellText font-semibold">8</div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-wrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-center"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                    </tr>

                    <tr>
                      <td><div class="cell cell-center"><div class="cellText font-semibold">9</div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-wrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-center"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                    </tr>

                    <tr>
                      <td><div class="cell cell-center"><div class="cellText font-semibold">10</div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-wrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-center"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                    </tr>

                    <tr>
                      <td><div class="cell cell-center"><div class="cellText font-semibold">11</div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-wrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-center"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                    </tr>

                    <tr>
                      <td><div class="cell cell-center"><div class="cellText font-semibold">12</div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-wrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-center"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                      <td><div class="cell cell-left"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div></td>
                    </tr>
                  </tbody>
                </table>
              </div>

            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const tbody = document.getElementById('tbody');
    const tableArea = document.getElementById('tableArea');

    function renumber(){
      [...tbody.querySelectorAll('tr')].forEach((tr, i) => {
        const no = tr.querySelector('td:first-child .cellText');
        if (no) no.textContent = String(i + 1);
      });
    }

    // Fit rows into fixed table-area height (rows shrink when more added)
    function fitRows(){
      const table = tableArea.querySelector('table');
      const thead = table.querySelector('thead');
      const rows = [...tbody.querySelectorAll('tr')];
      if (!rows.length) return;

      const areaH = tableArea.getBoundingClientRect().height;
      const headH = thead.getBoundingClientRect().height;
      const bodyH = Math.max(0, areaH - headH);

      const rowH = Math.floor(bodyH / rows.length);
      rows.forEach(tr => tr.style.height = rowH + 'px');
    }

    window.addEventListener('load', fitRows);
    window.addEventListener('resize', fitRows);

    document.getElementById('addRowBtn').addEventListener('click', () => {
      const tr = document.createElement('tr');
      const idx = tbody.children.length + 1;

      tr.innerHTML = `
        <td>
          <div class="cell cell-center"><div class="cellText font-semibold">${idx}</div></div>
        </td>
        <td>
          <div class="cell cell-left"><div class="cellText editable cell-wrap" contenteditable="true"></div></div>
        </td>
        <td>
          <div class="cell cell-center"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div>
        </td>
        <td>
          <div class="cell cell-left"><div class="cellText editable cell-nowrap" contenteditable="true"></div></div>
        </td>
      `;

      tbody.appendChild(tr);
      renumber();
      fitRows();
    });

    document.getElementById('removeRowBtn').addEventListener('click', () => {
      if (tbody.children.length > 1) tbody.removeChild(tbody.lastElementChild);
      renumber();
      fitRows();
    });

    async function waitForImages(root){
      const imgs = [...root.querySelectorAll('img')];
      await Promise.all(imgs.map(img => {
        if (img.complete && img.naturalWidth > 0) return Promise.resolve();
        return new Promise(res => {
          img.addEventListener('load', res, { once:true });
          img.addEventListener('error', res, { once:true });
        });
      }));
    }

    document.getElementById('pdfBtn').addEventListener('click', async () => {
      document.body.classList.add('exporting');
      if (document.activeElement) document.activeElement.blur();

      // final fit before capture
      fitRows();

      if (document.fonts && document.fonts.ready) {
        try { await document.fonts.ready; } catch(e){}
      }
      const el = document.getElementById('page');
      await waitForImages(el);

      const rect = el.getBoundingClientRect();

      const canvas = await html2canvas(el, {
        scale: 3,
        useCORS: true,
        backgroundColor: '#ffffff',
        logging: false,
        scrollX: 0,
        scrollY: 0,
        width: Math.round(rect.width),
        height: Math.round(rect.height),
        onclone: (doc) => {
          // Keep exact A4 + stable layout in clone
          const cloned = doc.getElementById('page');
          if (cloned){
            cloned.style.width = '210mm';
            cloned.style.height = '297mm';
            cloned.style.transform = 'none';
            cloned.classList.remove('rounded-xl');
            cloned.style.boxShadow = 'none';
          }

          // Fit rows in clone as well (important for PDF)
          const clonedArea = doc.getElementById('tableArea');
          if (clonedArea){
            const t = clonedArea.querySelector('table');
            const thead = t.querySelector('thead');
            const tbodyClone = t.querySelector('tbody');
            const rows = [...tbodyClone.querySelectorAll('tr')];

            const areaH = clonedArea.getBoundingClientRect().height;
            const headH = thead.getBoundingClientRect().height;
            const bodyH = Math.max(0, areaH - headH);
            const rowH = Math.floor(bodyH / rows.length);

            rows.forEach(r => r.style.height = rowH + 'px');
          }
        }
      });

      const imgData = canvas.toDataURL('image/png');

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      pdf.addImage(imgData, 'PNG', 0, 0, 210, 297);
      pdf.save('Lab_Report_Index_A4.pdf');

      document.body.classList.remove('exporting');
    });
  </script>

</body>
</html>
